/*global require, module, get, post */
var request = require("request");
var parse = require("cheerio").load;

function scrape(method, options, selection, cb) {
    'use strict';
    var regex = /\w:\/\//;
    if (!regex.test(options.url)) {
        options.url = 'http://' + options.url;
    }

    function get_matches(error, response, body) {
        if (error) {
            return cb(error);
        }
        
        if (response.statusCode !== 200) {
            return;
        }

        if (typeof selection === 'string') {
            selection = [selection];
        }

        var document = parse(body), result = [undefined].concat(selection.map(function (selector) {
            var elements = [],
                selected = document(selector);
            
            selected.each(function () {
                elements.push(document(this));
            });

            return elements;
        }));

        cb.apply(undefined, result);
    }
    request[method](options, get_matches);

}

function get(options, selection, cb) {
    'use strict';
    if (typeof options === 'string') {
        options = { url: options };
    }
    scrape('get', options, selection, cb);
}

module.exports = get;